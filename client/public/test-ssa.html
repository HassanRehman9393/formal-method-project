<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSA Transformation Tests</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow: auto;
    }
    .test-result {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
    }
    .test-success {
      border-left: 5px solid #4caf50;
    }
    .test-failure {
      border-left: 5px solid #f44336;
    }
    .source-code, .ssa-code {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre;
    }
    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .status-badge {
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    .success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .failure {
      background-color: #ffebee;
      color: #c62828;
    }
    .ssa-var {
      color: #2563eb;
    }
    .ssa-phi {
      color: #8b5cf6;
      font-weight: 500;
    }
    .ssa-label {
      color: #059669;
      font-weight: 500;
    }
    .ssa-goto {
      color: #b91c1c;
      font-weight: 500;
    }
    .summary {
      margin-top: 30px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #388e3c;
    }
  </style>
</head>
<body>
  <h1>SSA Transformation Tests</h1>
  <button id="run-tests">Run Tests</button>
  
  <div id="test-results"></div>
  
  <div id="summary" class="summary" style="display: none;">
    <h2>Test Summary</h2>
    <p>Total tests: <span id="total-tests">0</span></p>
    <p>Passed: <span id="passed-tests">0</span></p>
    <p>Failed: <span id="failed-tests">0</span></p>
  </div>

  <script type="module">
    import { parseProgram } from '../src/lib/parser/index.js';
    import { transformToSSA, formatSSA } from '../src/lib/ssa/index.js';
    import { generateSSAHTML } from '../src/lib/ssa/ssaVisualizer.js';

    // Test programs
    const testPrograms = [
      {
        name: 'Simple Assignment',
        code: 'x := 5;'
      },
      {
        name: 'Sequential Assignments',
        code: `x := 5;\ny := x + 3;\nz := x * y;`
      },
      {
        name: 'If Statement',
        code: `x := 10;\nif (x > 5) {\n  y := x * 2;\n} else {\n  y := x / 2;\n}\nz := y + 1;`
      },
      {
        name: 'While Loop',
        code: `sum := 0;\ni := 1;\nwhile (i <= 10) {\n  sum := sum + i;\n  i := i + 1;\n}`
      },
      {
        name: 'Assertion',
        code: `x := 5;\ny := x * 2;\nassert(y > x);`
      },
      {
        name: 'Nested If Statements',
        code: `x := 10;\nif (x > 5) {\n  if (x > 8) {\n    y := x * 3;\n  } else {\n    y := x * 2;\n  }\n} else {\n  y := x / 2;\n}\nz := y + 1;`
      },
      {
        name: 'Complex Expressions',
        code: `a := 5;\nb := 10;\nc := (a + b) * (a - b) / 2;\nd := c > 0 && a < b || !(c == 0);`
      },
      {
        name: 'For Loop',
        code: `sum := 0;\nfor (i := 1; i <= 5; i := i + 1) {\n  sum := sum + i * i;\n}\nassert(sum > 0);`
      }
    ];

    document.getElementById('run-tests').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = '<h2>Running tests...</h2>';
      
      let passedTests = 0;
      let failedTests = 0;
      let resultHtml = '';
      
      for (const test of testPrograms) {
        console.log(`Testing: ${test.name}`);
        resultHtml += `<div class="test-result">`;
        resultHtml += `<div class="test-header">`;
        resultHtml += `<h3>${test.name}</h3>`;
        
        try {
          // Parse the program
          const ast = parseProgram(test.code);
          
          // Transform to SSA
          const ssaProgram = transformToSSA(ast);

          // Format the SSA code
          const ssaCode = formatSSA(ssaProgram);

          // Display result
          resultHtml += `<span class="status-badge success">PASSED</span>`;
          resultHtml += `</div>`; // Close test-header
          
          resultHtml += `<div class="test-content">`;
          resultHtml += `<h4>Source Code:</h4>`;
          resultHtml += `<pre class="source-code">${test.code}</pre>`;
          
          resultHtml += `<h4>SSA Form:</h4>`;
          resultHtml += `<pre class="ssa-code">${generateSSAHTML(ssaCode)}</pre>`;
          resultHtml += `</div>`; // Close test-content
          
          passedTests++;
        } catch (error) {
          resultHtml += `<span class="status-badge failure">FAILED</span>`;
          resultHtml += `</div>`; // Close test-header
          
          resultHtml += `<div class="test-content">`;
          resultHtml += `<h4>Source Code:</h4>`;
          resultHtml += `<pre class="source-code">${test.code}</pre>`;
          
          resultHtml += `<h4>Error:</h4>`;
          resultHtml += `<pre class="error">${error.message || error}</pre>`;
          resultHtml += `<pre class="error-stack">${error.stack || ''}</pre>`;
          resultHtml += `</div>`; // Close test-content
          
          failedTests++;
          console.error('Test failed:', error);
        }
        
        resultHtml += `</div>`; // Close test-result
      }
      
      // Show results
      resultsDiv.innerHTML = resultHtml;
      
      // Update summary
      document.getElementById('total-tests').textContent = testPrograms.length;
      document.getElementById('passed-tests').textContent = passedTests;
      document.getElementById('failed-tests').textContent = failedTests;
      document.getElementById('summary').style.display = 'block';
    });
  </script>
</body>
</html>
